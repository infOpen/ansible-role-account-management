---

# Main task file for account-management role

- name: 'Manage account create'
  include: 'create_accounts.yml'
  no_log: True
  tags:
    - 'account-management::role'
    - 'account-management::config'


- name: 'Create user authorized-keys file'
  become: True
  authorized_key:
    user: "{{ item.0.name }}"
    key: "{{ lookup('file', item.1.filename) }}"
    state: "{{ item.1.state | default('present') }}"
    key_options: "{{ item.1.key_options | default('') }}"
    exclusive: "{{ item.0.exclusive_public_keys | default(True) }}"
  no_log: True
  with_subelements:
    - "{{ account_management_users }}"
    - 'authorized_public_keys'
    - flags:
      skip_missing: true
  tags:
    - 'account-management::role'
    - 'account-management::config'


- name: 'Secure home folders'
  include: 'secure_home.yml'
  no_log: True
  tags:
    - 'account-management::role'
    - 'account-management::config'
